---
title: 面试题-进程、线程、协程
date: 2020-03-02 23:53:16
tags: [面试, 操作系统]
---

进程、线程、协程是操作系统实现并发的最基础的概念，也是面试必须掌握的知识。仅仅简单的对概念进行理解是比较简单的，但是要深入理解设计的本质及原理，则需要一系列相关的知识来辅助。接来下我们就进程、线程、协程的原理进行分析，并讨论其相关扩展概念。

<!--more-->

# 概念及缘起
在介绍进程、线程和协程之前，我们必须了解两个概念：**并行**和**并发**。
### 并行（parallel）
并行指的是，在同一时刻（时间点），有多个操作指令在同时执行。由于单个CPU一个时刻只能执行一个指令，显然并行的前提是多核心。
{% asset_img parallel.jpg %}

### 并发（concurrency）
尽管在同一时刻单个CPU仅能执行一个指令，但是将多个进程的指令快速轮换执行，可以造成一种假象：在一段时间内（宏观上）有多个进程在同时执行，但实际上只是将时间分成若干片并分配给不同进程，这就是并发。
{% asset_img concurrency.jpg %}

在了解了并行和并发的概念后，我们进入正题。

### 进程
在计算机仅有单核心的时代，当一个任务A占用CPU，其他任务只能等待任务A完成后才能抢占CPU。但当任务A遇到IO等阻塞操作时，A在等待时仍然占用CPU，其他任务也只能处于等待状态，这无疑是对CPU资源的极大浪费。在这个情况下，任务**切换**是最为合适的解决办法：当任务A处于阻塞时放弃CPU的占用交由其他任务使用，当A结束阻塞状态时再恢复A的状态。
切换解决了CPU资源浪费的问题，也带来了如何恢复阻塞前状态的问题。因此发明了**进程**的概念用于存储任务占用的资源（地址空间、全局变量、文件描述符、硬件资源等），进程状态的记录、恢复、切换称为**上下文切换**。

> - 进程的出现是为了更好的利用CPU资源使并发成为可能。
> - **进程是系统资源分配的最小单位**。

##### 进程的状态
- 等待态：等待某个事件的完成
- 就绪态：等待系统分配处理器以便运行
- 运行态：占有处理器正在运行

### 线程
在有了进程后，很大程度上解决了操作系统并发问题，但是由于进程切换需要陷入内核会有较大的**性能开销**；且进程粒度较大，进程间**资源不共享**，如果一个进程想要并发的执行多个操作，则每个操作均需要成为一个进程，进程通信等方面均有很大问题。
解决上述问题的一个办法是，在进程内部划分更细的粒度，他们**共享进程内部资源**，**参与操作系统调度**，且拥有自己的单独资源（栈、寄存器等），这就是线程。

> - **线程是系统分配处理器时间资源的基本单位**。
> - **线程是操作系统调度的最小单位**。
> - **进程可以说是线程的容器**，进程均拥有一个主线程。

### 协程
有了进程线程模型后，基本可以满足一般的并发操作。但是当出现大规模并发连接时，操作系统需要不停的进行上下文切换，**调度开销**很大。
既然性能瓶颈在于系统调度，那么是否可以由**线程自行完成调度**（由程序员自行进行调度），避免进行陷入内核的系统调度过程呢？这就是协程的简单概念。

> **协程就是在用户程序中实现了协作式任务调度**。

### 进程、线程、协程区别
- 进程拥有独立的堆和栈，堆栈均不共享；由操作系统调度。
- 线程拥有独立的栈和共享的堆，共享堆，不共享栈；线程亦由操作系统调度。
- 协程同线程一致，共享堆，不共享栈；由程序员在代码层面完成协程调度。

> 进程是一个空间概念，在进程空间内可以共享系统资源、内存等，但是进程不具备执行的能力；
> 
> 线程是一个时间概念，线程可以真正的占有CPU时间片执行指令，每个进程至少有一个主线程来进行操作系统调度；
> 
> 线程调度由系统决定，想要调整顺序则需要**锁**来实现；协程则由用户决定（串形执行），且不需要陷入内核开销极小，但由于均在同一线程中自然无法利用多核CPU的优势。

### 参考
1. [进程，线程，协程与并行，并发](https://www.jianshu.com/p/f11724034d50)
2. [并发和并行的区别](https://www.jianshu.com/p/cbf9588b2afb)