---
title: 伙伴系统和slab内存分配机制
date: 2020-02-28 02:24:46
tags: [操作系统]
---

在前面一篇文章[Linux内存管理-从操作系统角度看可执行文件的装载](https://wjj954628981.github.io/2020/02/25/Linux内存管理/)中，我们通过一个可执行文件的运行装载过程中，深入了解了Linux内存的管理方式：分段、分页。内存分配的最小单位为页框，其大小为4k，对于需要频繁申请释放不同大小内存的进程（例如操作系统内核），必然导致在已分配页框的中分散了许多小块的空闲内存。下面我们来介绍两个策略，以便管理用于内核进程的空闲内存：**伙伴系统**和**slab分配机制**。

<!--more-->

# 伙伴系统（Buddy System）
伙伴系统将空闲页框按照固定大小：1、2、4...1024，分组到一个链表中。

### 伙伴（Buddy）的定义：
- 两个块大小相同
- 两个块地址连续
- 两个块必须是同一个大块中分离出来的

#### 优点
通过合并的技术，可以将相邻伙伴快速组合以形成更大分段
#### 缺点
由于圆整到下一个 2 的幂，很可能造成分配段内的碎片；拆分合并涉及较多链表位图操作，开销较大。

# slab分配机制
slab分配器针对一些**经常分配并释放**的对象（例如进程描述符、文件对象、信号量等），对其进行**分类管理**（按照大小）。

这些**对象比较小**，如果直接采用伙伴系统来进行分配和释放，不仅会造成大量的内碎片，而且处理速度也太慢。

{% asset_img slab内存分配机制.jpg %}

> 每个slab由一个或多个物理连续的页面组成，每个cache由一个或多个slab组成，每类内核数据结构都有一个cache。

### 分配过程
slab处于以下三种可能状态：
- 满的：slab的所有对象标记为使用。
- 空的：slab上的所有对象标记为空闲。
- 部分：slab上的对象有的标记为使用有的标记为空闲。

1. slab分配器首先尝试在部分为空的slab中用空闲对象来满足请求。
2. 如果不存在，则从空的slab中分配空闲对象。
3. 如果没有空的slab可用，则从连续物理页面分配新的slab，并将其分配给cache；从这个slab上，再分配对象内存。

### 优点
- 没有因碎片而引起内存浪费。
- 对象已预创建，可以快速满足内存请求。