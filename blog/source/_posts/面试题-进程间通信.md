---
title: 面试题-进程间通信
date: 2020-03-06 03:19:16
tags: [面试, 操作系统]
---

在上一篇文章[面试题-进程、线程、协程](https://wjj954628981.github.io/2020/03/02/面试题-进程、线程、协程/)中，我们介绍了进程、线程和协程的概念。对于线程和协程而言，他们共享进程的内存空间，可以很简单进行通信；而对于进程而言，由于其独立的内存空间，无法进行直接通信，因此**进程间通信（InterProcess Communication，IPC）**尤为重要。

<!--more-->

# 概述
进程间要实现通信，必定需要在一个公共区域共享一块公共资源，通过进程均可读写该资源实现进程间通信。
按照以上逻辑，可以将进程间通信方式分为以下三类：

1. 共享文件系统，需要穿过内核空间
2. 共享内核信息（如pipe、FIFO、XSI）
3. 共享内存区

{% asset_img 进程间通信方式.jpg %}

接下来我们对后两种的具体实现方式进行详细描述分析。

# 管道
## 概述及局限性
管道是UNIX系统IPC的最古老形式，所有UNIX系统都提供此种通信机制。管道可以类比为一根水管，数据从一端流入从另一段流出。
管道有以下两种局限性：
- 半双工（**数据只能在一个方向上流动**）
- 管道只能在具有公共祖先的两个进程之间使用
> 尽管管道有这两种局限性，但是shell执行均通过管道实现，因此仍是最常用的IPC形式。

## 管道的创建
管道通过调用pipe函数创建：
```
#include <unistd.h>
//成功返回0，错误返回-1
int pipe(int fd[2]);
```
fd返回两个文件描述符：fd[0]为读而打开，fd[1]为写而打开。如下图所示：
{% asset_img fork之后的半双工管道.jpg%}

## 管道的使用
最常见的操作是创建一个连接到另一个进程的管道，然后读其输出或向其输入段发送数据，为此标准I/O库提供了两个函数popen和pclose。
```
#include <stdio.h>
//成功返回文件指针，错误返回NULL
//如果type是"r"，则返回的文件指针是可读的；如果type是"w"，则返回的文件指针是可写的
FILE *popen(const char *cmdstring, const char *type);
//成功返回cmdstring的终止状态，错误返回-1
int pclose(FILE *fp);
```

# 协同进程
UNIX系统**过滤程序**从标准输入读取数据，向标准输出写数据。几个过滤程序通常在shell管道中线性连接。当一个过滤程序既产生某个过滤程序的输入，又读取改过滤程序的输出，它就变成了协同进程。图示如下：
{% asset_img 协同进程.jpg%}
> 协同进程可以说是管道的一个特殊应用。

# FIFO（命名管道）
管道有局限性2:只能在具有公共祖先的两个进程之间使用。这个局限性对于进程间通信很不友好，但是通过FIFO，不相关的进程也能交换数据。
> **FIFO是一种文件类型**

## FIFO的创建
由于FIFO是一种文件类型，创建FIFO类似于创建文件。
```
#include <sys/stat.h>
//以下两个函数，成功返回0，错误返回1
int mkfifo(const char *path, mode_t mode);
int mkfifoat(int fd, const char *path, mode_t mode);
```

## FIFO的使用
FIFO可以通过任何文件I/O函数打开，比如open。
当open一个FIFO时，非阻塞标志（O_NONBLOCK）会产生下列影响：
- 一般情况下（没有指定O_NONBLOCK），只读（只写）open需要阻塞到某个其他进程为了写（读）而打开这个FIFO为止；
- 如果指定了O_NONBLOCK，只读open立即返回。但是如果没有任何进程为读而打开改FIFO，那么只写open将返回-1，并将errno设置为ENXIO。
当write一个FIFO：
- 若write一个没有任何进程为读而打开的FIFO，则产生信号SIGPIPE；
- FIFO的最后一个写进程关闭该FIFO，则将为该FIFO的读进程产生一个文件结束标志。

## FIFO的用途
- shell命令使用FIFO将数据从一条管道传递到另一条时，**无需创建中间临时文件**。
```
//tee命令用于将数据重定向到文件，另一方面还可以提供一份重定向数据的副本作为后续命令的stdin。
//简单的说就是把数据重定向到给定文件和屏幕上。
mkfifo fifo1
prog3 < fifo1 &
prog1 < infile | tee fifo1 | prog2
```
以上shell命令的数据流如下图所示：
{% asset_img FIFO管道数据传递.jpg%}

- **客户-服务器**进程应用程序中，FIFO用作汇聚点，在客户进程和服务器进程之间传递数据
{% asset_img FIFO客户-服务器.jpg%}

> 综上，**FIFO起到了临时文件但是不需要占用磁盘空间的作用**

# XSI IPC
有三种称作XSI IPC的IPC：**消息队列**、**信号量**以及**共享存储器**。他们之间有很多相似之处。

## 相似处

### 标识符和键
1. 每个内核中的IPC结构，都用一个非负整数的标识符加以引用。
2. 标识符是IPC对象的内部名，为了使多个合作进程能够在同一IPC对象上汇聚，需要提供一个**外部命名方案**：将每个IPC对象与一个键（数据类型为<sys/types.h>中的长整型key_t）相关联，将这个键作为该对象的外部名。

> - 与文件描述符不同，IPC描述符不是一个小的整数。当一个IPC结构被创建然后又被删除时，与这种结构相关的标识符连续加1直到达到最大正整型数后转回0循环。
> - 创建IPC结构时可以指定键**IPC_PRIVATE**。
> - 可以通过**get**函数（msgget、semget、shmget）通过key来获得IPC结构。

### 权限结构
XSI IPC为每一个IPC结构关联了一个**ipc_perm**结构，规定了权限及所有者。

> - 可以通过**ctl**函数（msgctl、semctl、shmctl）修改权限字段。
> - IPC结构均没有执行权限。

### 结构限制
三种形式的XSI IPC均有内置限制，大部分限制可以通过重新配置内核来修改。

> 可以通过ipcs -l / ipcs -T命令查看限制。

### 缺点
- IPC结构没有引用计数，无法自动清理
- IPC结构在文件系统中没有名字，导致操作复杂繁琐
- IPC结构不使用文件描述符，因此无法使用I/O多路复用

## 消息队列
消息队列是消息的链接表，存储在内核中，由消息队列标识符标识。

> 每个消息队列均有一个msqid_ds结构与之关联，定义了当前队列的状态

### 操作
- 打开/创建
```
#include <sys/msg.h>
//成功返回消息队列ID，出错返回-1
int msgget(key_t key, int flag);
```

- 放入消息
```
#include <sys/msg.h>
//成功返回0，出错返回-1
//flag类似于文件I/O的非阻塞I/O标志
int msgsnd(int msqid, const void *ptr, size_t nbytes, int flag);

//ptr指向的消息结构
struct mymesg {
    long mtype;
    char mtext[512];
};
```
> 消息插入队列末尾

- 取出消息
```
#include <sys/msg.h>
//成功返回消息数据部分长度，出错返回-1
ssize_t msgrcv(int msqid, void *ptr, size_t nbytes, int flag);
```

## 信号量
信号量与已经介绍过的IPC机构（管道、FIFO、消息队列）不同，它是一个计数器，用于为多个进程提供对共享数据对象的访问。

### 信号量的工作方式
为了获得共享资源，进程需要进行如下操作：
1. 获得控制该资源的信号量
2. 如果信号量的值为正，则进程可以使用该资源，信号量值-1
3. 如果信号量的值为0，则进程休眠直至信号量值大于0，进程被唤醒
4. 如果进程释放资源，则信号量值+1；如果有进程正在休眠等待此信号量，则唤醒它们

> 信号量值操作均应该为**原子操作**
> XSI信号量在此基础上复杂了许多
> **记录锁**和**共享存储中互斥量**均可实现资源的共享

## 共享存储
共享存储允许多个进程共享一个给定的存储区。因为数据不需要在客户进程、服务器进程之间复制，所以这是最快的一种IPC。

> **mmap**也可实现共享存储（将一个文件的若干部分映射至进程地址空间），XSI共享存储段则是内存的匿名段。
> 需要通过信号量等机制同步对共享存储的访问。

# 网络IPC：套接字
前面的IPC机制允许同一台计算机上的进程实现通信，而**网络进程间通信（network IPC）**则允许通过网络连接的不同计算机上的进程实现通信。该部分内容较多，将在后续文章中进行统一介绍。

### 参考
1. 《Unix环境高级编程-第15章.进程间通信》
2. [IPC 机制简介](https://www.cnblogs.com/chenny7/p/3682822.html)