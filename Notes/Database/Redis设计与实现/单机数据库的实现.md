# 单机数据库的实现
## 数据结构
```
redis.h/redisServer  //Redis服务器
struct redisServer {
    redisDb *db;  //保存服务器所有数据库的数组
    int dbnum;  //服务器数据库数量，默认16
    //...
};

//Redis客户端
typedef struct redisClient {
    redisDb *db;  //记录客户端当前使用的数据库
    //...
} redisClient;

//redis.h/redisDb  // Redis数据库结构
typedef struct redisDb {
    dict *dict;  //数据库键空间
    dict *expires;  //过期字典
    //...
} redisDb;
```
![Redis整体结构图.jpg](../pic/Redis整体结构图.jpg)
>数据库的键空间是一个字典，因此所有针对数据库的操作，都是通过对键空间字典进行操作来实现的。
## 过期时间
```
//设置生存时间ttl（time to live），P开头为ms，否则为s
EXPIRE <key> <ttl>
PEXPIRE <key> <ttl>

//设置过期时间
EXPIREAT <key> <timestamp>
PEXPIREAT <key> <timestamp>

//计算并返回剩余生存时间
TTL <key>
```
>```EXPIRE```、```PEXPIRE```、```EXPIREAT```均通过```PEXPIREAT```实现。

>通过查询过期字典获得的过期时间与当前时间做比较判断键是否过期。
### 过期键删除
- 定时删除：创建定时器。对CPU不友好，对内存友好。
- 惰性删除：读写键时判断是否过期，过期则删除。对内存不友好，对CPU友好。
- 定期删除：每隔一段时间检查过期键并删除。
>Redis采用惰性删除和定期删除两种策略的配合。

>定期删除会记录上一次检查过期键的进度并保存，在下次开始执行时继续。
### AOF、RDB和复制对过期键处理
- RDB
```mermaid
graph LR
生成RDB-->过滤过期键
载入RDB-->|主|过滤过期键
载入RDB-->|从|保存所有键
```
-  AOF
AOF生成载入均不对键做任何处理。当过期键被删除，程序会向AOF文件append一条DEL命令。
- 复制
主服务器删除过期键，会向所有从服务器发送DEL命令

---

# RDB持久化
## RDB文件的创建与载入
RDB文件是一个经过压缩的**二进制文件**，通过该文件可以完成数据库状态还原。
```SAVE```和```BGSAVE```命令用于创建RDB文件，```SAVE```会直接阻塞服务器（拒绝一切命令），```BGSAVE```会派生子进程负责创建RDB文件。
>AOF的更新频率更高，优先级更高。

### 自动间隔性保存
```
struct redisServer {
    //...
    struct saveparam *saveparams;  //保存条件的数组
    long long dirty;  //修改计数器，每次修改操作+1
    time_t lastsave;  //上一次执行保存的时间
    //...
};

//seconds秒内至少进行changes次修改则进行BGSAVE命令
struct saveparam {
    time_t seconds;  //秒数
    int changes;  //修改数
};
```
Redis服务器的周期性操作函数```serverCron```默认每100毫秒执行一次，其一项工作就是遍历检查saveparams中的保存条件，满足则执行```BGSAVE```;
## RDB文件结构
![RDB文件结构.svg](../pic/RDB文件结构.svg)
>- INTSET将整数集合转换为字符串对象后保存；
>- ZIPLIST将压缩表对象转换为字符串对象后保存。

TYPE记录了value的类型，列表如下：
- REDIS_RDB_TYPE_STRING
- REDIS_RDB_TYPE_LIST
- REDIS_RDB_TYPE_SET
- REDIS_RDB_TYPE_ZSET
- REDIS_RDB_TYPE_HASH
- REDIS_RDB_TYPE_LIST_ZIPLIST
- REDIS_RDB_TYPE_SET_INTSET
- REDIS_RDB_TYPE_ZSET_ZIPLIST
- REDIS_RDB_TYPE_HASH_ZIPLIST